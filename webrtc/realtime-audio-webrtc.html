<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>
        Realtime Audio with WebRTC - OpenAI GPT Realtime Model
    </h1>
    <button id="connection">Connect With LLM</button>
    
    <script>
    let audioElement; // Declare audio element variable

    async function Connection() {
        
        const tokenResponse = await fetch("http://localhost:3000/token");
        const data = await tokenResponse.json();
        const EPHEMERAL_KEY = data.value;

        console.log("Ephemeral Key:", EPHEMERAL_KEY);

        // Create a peer connection
        const pc = new RTCPeerConnection();

        // Set up to play remote audio from the model
        audioElement = document.createElement("audio");
        audioElement.autoplay = true;
        document.body.appendChild(audioElement); // Add to DOM
        pc.ontrack = (e) => (audioElement.srcObject = e.streams[0]);
        
        // Add local audio track for microphone input in the browser
        const ms = await navigator.mediaDevices.getUserMedia({
            audio: true,
        });
        pc.addTrack(ms.getTracks()[0]);
        
        // Set up data channel for sending and receiving events
        const dc = pc.createDataChannel("oai-events");
        
        // Start the session using the Session Description Protocol (SDP)
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        const baseUrl = "https://api.openai.com/v1/realtime/calls";
        const model = "gpt-4o-mini-realtime-preview";
        const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
            method: "POST",
            body: offer.sdp,
            instructions: "You are a helpful assistant.Please answer the user's questions in ENGLISH only",
            headers: {
                Authorization: `Bearer ${EPHEMERAL_KEY}`,
                "Content-Type": "application/sdp",
            },
        });
        
        const answer = {
            type: "answer",
            sdp: await sdpResponse.text(),
        };
        console.log("Received answer:", answer);
        await pc.setRemoteDescription(answer);
    }

    document.getElementById("connection").onclick = function() {
        Connection();
    }
    </script>
  </body>
</html>


