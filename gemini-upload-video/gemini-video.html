<!DOCTYPE html>
<html>
<head>
    <title>Video Analysis</title>
</head>
<body>
    <h1>Video Analysis with Gemini</h1>
    
    <input type="file" id="videoFile" accept="video/*" />
    <br><br>
    
    <video id="videoPreview" width="400" controls style="display:none;"></video>
    <br><br>
    
    <input type="text" id="question" placeholder="Ask a question about the video" size="50" />
    <br><br>
    
    <button id="analyzeBtn">Ask Question</button>
    <br><br>
    
    <div id="loading" style="display:none;">Analyzing video...</div>
    <div id="response"></div>

    <script type="module">
        // Replace with your actual API key
        import { GEMINI_KEY } from './key.js';
        const API_KEY = GEMINI_KEY;
        
        let videoBase64 = null;
        let videoMimeType = null;

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function analyzeVideo() {
            const question = document.getElementById('question').value.trim();
            
            if (!videoBase64) {
                alert('Please upload a video first');
                return;
            }
            
            if (!question) {
                alert('Please enter a question');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('response').innerHTML = '';

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent', {
                    method: 'POST',
                    headers: {
                        'x-goog-api-key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    inline_data: {
                                        mime_type: videoMimeType,
                                        data: videoBase64
                                    }
                                },
                                {
                                    text: question
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'API request failed');
                }

                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response received';
                document.getElementById('response').innerHTML = '<h3>Response:</h3><p>' + aiResponse + '</p>';

            } catch (error) {
                document.getElementById('response').innerHTML = '<h3>Error:</h3><p>' + error.message + '</p>';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Event listeners
        document.getElementById('videoFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Show video preview
            const videoUrl = URL.createObjectURL(file);
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.src = videoUrl;
            videoPreview.style.display = 'block';
            
            // Convert to base64
            videoMimeType = file.type;
            videoBase64 = await fileToBase64(file);
            console.log('Video ready for analysis');
        });

        document.getElementById('analyzeBtn').addEventListener('click', analyzeVideo);
    </script>
</body>
</html>

//if there is any video file, convert it to base64 and send it to the API along with the question if it is < 20MB
//if the video is > 20MB, first we have to upload it to a server and then send the URL to the API along with the question 