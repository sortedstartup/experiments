<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenAI Realtime WebRTC - Auto VAD</title>
</head>
<body>
    <h1>Realtime Audio with WebRTC - Auto VAD</h1>
    <button id="connection">Connect With LLM</button>
    <div id="status">Click Connect to start</div>
    
    <script>
    let audioElement;
    let dataChannel;
    let isConnected = false;
    let pc = null;

    async function Connection() {
        try {
            document.getElementById("status").textContent = "Connecting...";

            // Create peer connection
            pc = new RTCPeerConnection();

            // ICE candidate handling
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    fetch("http://localhost:3000/ice-candidate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ candidate: event.candidate })
                    }).catch(err => console.error("Error sending ICE candidate:", err));
                }
            };

            // Connection state monitoring
            pc.onconnectionstatechange = () => {
                console.log("Connection state:", pc.connectionState);
                
                if (pc.connectionState === 'connected') {
                    document.getElementById("status").textContent = "Connected - Setting up session...";
                } else if (pc.connectionState === 'failed') {
                    document.getElementById("status").textContent = "Connection failed. Try again.";
                } else {
                    document.getElementById("status").textContent = `Connection: ${pc.connectionState}`;
                }
            };

            // Set up audio playback
            audioElement = document.createElement("audio");
            audioElement.autoplay = true;
            document.body.appendChild(audioElement);
            
            pc.ontrack = (e) => {
                audioElement.srcObject = e.streams[0];
                console.log("ðŸ”Š Audio stream received from OpenAI");
            };
            
            // Add microphone
            const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
            pc.addTrack(ms.getTracks()[0]);
            console.log("ðŸŽ¤ Microphone streaming to OpenAI");
            
            // Set up data channel
            dataChannel = pc.createDataChannel("oai-events");
            
            dataChannel.onopen = () => {
                console.log("âœ… Data channel opened");
                console.log("ðŸ“¤ Session configured with VAD");
            };
            
            // Simple message handling - VAD does everything
            dataChannel.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log("ðŸ“¨ Received:", message.type);
                
                if (message.type === "session.created") {
                    console.log("ðŸŽ¯ Session ready with VAD!");
                    document.getElementById("status").textContent = "âœ… Ready - Just speak naturally!";
                    document.getElementById("connection").textContent = "Connected";
                    document.getElementById("connection").disabled = true;
                    isConnected = true;
                    
                } else if (message.type === "session.updated") {
                    console.log("ðŸ“‹ VAD session configured");
                    
                } else if (message.type === "input_audio_buffer.speech_started") {
                    console.log("ðŸŽ¤ Detected speech start");
                    document.getElementById("status").textContent = "ðŸŽ¤ Listening...";
                    
                } else if (message.type === "input_audio_buffer.speech_stopped") {
                    console.log("ðŸ”‡ Detected speech stop");
                    document.getElementById("status").textContent = "ðŸ¤” Processing...";
                    
                } else if (message.type === "response.created") {
                    console.log("ðŸŽ¯ Auto-generating response");
                    document.getElementById("status").textContent = "ðŸ¤– Generating response...";
                    
                } else if (message.type === "response.audio.delta") {
                    document.getElementById("status").textContent = "ðŸ”Š AI speaking...";
                    
                } else if (message.type === "response.done") {
                    console.log("âœ… Response completed");
                    document.getElementById("status").textContent = "âœ… Ready - Speak again!";
                    
                } else if (message.type === "error") {
                    console.error("âŒ Error:", message);
                    document.getElementById("status").textContent = `Error: ${message.error?.message}`;
                }
            };

            dataChannel.onerror = (error) => {
                console.error("âŒ Data channel error:", error);
                document.getElementById("status").textContent = "Data channel error";
            };

            // Create offer and send to backend
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            const response = await fetch("http://localhost:3000/webrtc-offer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ offer: offer })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const { answer } = await response.json();
            await pc.setRemoteDescription(answer);
            
            console.log("WebRTC connection initiated");
            
        } catch (error) {
            console.error("Connection failed:", error);
            document.getElementById("status").textContent = `Failed: ${error.message}`;
        }
    }

    document.getElementById("connection").onclick = () => {
        if (!isConnected) Connection();
    };
    </script>
</body>
</html>
